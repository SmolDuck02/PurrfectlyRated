{% extends "master.html" %}
{% load static %}

{% block head %}
    <link rel="stylesheet" type="text/css" href="{% static 'home.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'view_post.css' %}">
{% endblock %}


{% block content %}
{% include "add_post.html" with from_page='home' %}


<div class="homeBody">

        <div class="searchBarContainer">
            <div class="top">
                <img src="{% static '/img/logo.png' %}" class="profileMiniUserPicture" alt="mini user pfp"/>
                <div id="makeReviewHeader" name="makeReviewHeader">Got something to say?</div>
                <i class="fa-solid fa-image" style="color: rgb(182, 106, 29);"></i>
                <!-- <button class="pawButton"><i class="fa-solid fa-paw "></i> </button> -->
            </div>
        </div>

        <div class="navigateContentParent">
            <div id="feedContentButton">
                <h2 >Reviews</h2>
            </div>
            <div id="productContentButton">
               <h2 >Products</h2> 
            </div>
            
        </div>
     

        <div class="allReviewPostsParent">
            {% for post in post_list %}
            {% with post_id=post.id %}
                {% include "view_post.html" %}
            {% endwith %}
                <div id="reviewPostContainer-{{ post.id }}" data="{{ post }}">
                    <div class="after">
                        <h3>This post has been deleted!</h3>
                        <form action="/undelete_post/{{ post.id }}" method="post" >
                            {% csrf_token %}
                            <i id="undoDeletePostButton-{{ post.id }}" class="fa-solid fa-arrow-rotate-left fa-lg"></i>
                        </form>
                    
                    </div>
                    
                    <div class="before">
                        <div class="headerPost">
                            <img src="{% static '/img/logo.png' %}" class="profileMiniUserPicture" alt="mini user pfp"/>
                            <div class="userPostDetails">
                                <h2>{{ post.postUser__username | title }}</h2>
                                <span>{{ post.datetimePublished }}</span>
                            </div>
                            {% if post.postUser__id == request.session.user_id %}
                                <i id="makeChangesButton-{{ post.id }}" class="fa-solid fa-pen"></i>
                            {% endif %}
                            
                            <div style="width: 10px;"></div>
                            {% if post.postUser__username != 'admin' %}
                                <form id="deletePostForm-{{ post.id }}" method="post">
                                {% csrf_token %}
                                    <i id="deletePostIcon-{{ post.id }}" class="fa-solid fa-x fa-lg"></i>
                                </form>
                            {% endif %}
                        </div>

                        <div class="descriptionPost">
                            <span>{{ post.post_description }}</span>
                        </div>
    
                        <div class="imagesPost">
                            <img id="changeImage-{{ post.id }}" src="/media/{{ post.post_picture }}" alt="postImages">
                        </div>

                        <div class="buttonsPost">
                            <div>
                                <i id="like-{{ post.id }}" class="fa-solid fa-arrow-up fa-lg"></i>
                                <i id="dislike-{{ post.id }}" class="fa-solid fa-arrow-up fa-rotate-180 fa-lg"></i>
                            </div>
                            <i id="-{{ post.id }}" class="fa-solid fa-comment fa-lg" style="border-left: 2px solid #bdbdbd;padding: 15px;"></i>
                            <i id="favorite-{{ post.id }}" class="fa-solid fa-heart fa-lg" style="border-left: 2px solid #bdbdbd;padding: 15px;"></i>
                        </div>
                    </div>
                </div>
                
 

                
                <div id="makeChangesDiv-{{ post.id }}">
                    <div class="makeReviewForm">
                        <div class="before">
                            <div class="headerPost">
                                <img src="{% static '/img/logo.png' %}" class="profileMiniUserPicture" alt="mini user pfp"/>
                                <div class="userPostDetails">
                                    <h2>{{ user.username | title }}</h2>
                                </div>
                                <i id="cancelPostIcon-{{ post.id }}" class="fa-solid fa-x" style="cursor: pointer;"></i>
                    
                                <!-- <i class="fa-solid fa-ellipsis fa-lg" style="color: #cc8033;"></i> -->
                            </div>
                            <form id="makeChangesForm-{{ post.id }}" class="makeChangesForm" action="/update_post/{{ post.id }}" method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="descriptionPost">
                                    <textarea id="description" name="description" style="width: 100%; min-width: 100%; min-height: 20px; background-color:#ffead1; height: 20px; padding: 10px; border: none;" placeholder="Speak Now...">{{ post.post_description }}</textarea>
                                    <!-- <input id="postDescription" name="postDescription" type="text"  style="white-space: pre-wrap;" placeholder="Speak Now..." required> -->
                                </div>
                                
                                <div id="imagesChangePost-{{ post.id }}" class="imagesChangePostDiv">
                                    <i class="fa-solid fa-image fa-lg">&nbsp; Add Images</i>
                                    <input type="file" id="changeImageInput-{{ post.id }}" name="changeImageInput" accept="image/*" style="display: none;" />
                                </div>
                                <button type="submit" id="publishReviewButton">Save Changes</button>
                            </form>
                            
                        </div>
                    </div>
                </div>
                
            {% endfor %}
        </div>

        <div class="allProductPostsParent">
            {% for product in product_list %}
                <div class="productContainer">
                    <img src="/media/{{ product.product_picture }}">
                    <div class="productCategoryContainer">
                        <i class="{{ product.product_category__category_icon }}"></i>
                        <h5>{{ product.product_category__category_name }}</h5>
                    </div>
                    <div class="productNameContainer">
                        <h3>{{ product.product_name }}</h3>
                        <i id="makeReviewButton" class="fa-solid fa-pen"></i>
                    </div>
                    
                </div>
            {% endfor %}
        </div>


        <script>

            let to_delete_list = [];
            const feedContentButton = document.getElementById("feedContentButton");
            //to make it active already
            feedContentButton.classList.toggle("active");

            const productContentButton = document.getElementById("productContentButton");
            const deletePostIcon = document.getElementById("deletePostIcon");
            
            const undoDeletePostButtons = document.querySelectorAll(".fa-solid.fa-arrow-rotate-left.fa-lg");

            const makeChangesButton = document.getElementById("makeChangesButton");
            const makeReviewButtons = document.querySelectorAll(".fa-solid.fa-pen");
            const cancelButtons = document.querySelectorAll(".fa-solid.fa-x");
   
            const uploadImageDiv = document.querySelector(".imagesAddPost");
            const uploadImageInput = document.getElementById("uploadImageInput");

  
            const feedContentDiv = document.querySelector(".allReviewPostsParent");
            const productContentDiv = document.querySelector(".allProductPostsParent");


            const imagesChangePostDivs = document.querySelectorAll(".imagesChangePostDiv");
            imagesChangePostDivs.forEach((div) => {

                const changeImageInput = div.querySelector('input[type="file"]');

                div.addEventListener("click", (event) => {
                    event.stopPropagation();
                    changeImageInput.click();
                });

                changeImageInput.addEventListener('change', function () {
                    const selectedFile = this.files[0];
                    if (selectedFile) {
                        const imageURL = URL.createObjectURL(selectedFile);
                        div.style.backgroundImage = `url(${imageURL})`;
                    }
                });
            });


        
            const commentButtons = document.querySelectorAll(".fa-solid.fa-comment.fa-lg");
            commentButtons.forEach((button) => {
                button.addEventListener("click", (event) => {
                    event.stopPropagation();
                    const clickedId = event.target.id;
                    const postId = clickedId.split("-")[1];
                    
                    //another approach - tedious
                    // const post = document.getElementById(`reviewPostContainer-${postId}`).getAttribute("data");

                    //if there is ID, then proceed
                    if(clickedId){
                       const divvy = document.getElementById(`viewPostDivBackground-${postId}`);
                        divvy.style.display = "flex";
                        console.log(divvy);
                        // document.querySelector(".viewPostDivBackground").style.display = "flex";
                    }
                    
                })
            });


            //makepost from the thing in home
            const makeReviewHeader = document.getElementById("makeReviewHeader");
            makeReviewHeader.addEventListener("click", ()=>{
                document.querySelector(".makeReviewDiv").style.display = "flex";
            });


            makeReviewButtons.forEach((icon) => {
                icon.addEventListener("click", (event) => {
                    event.stopPropagation();
                    const clickedId = event.target.id;
                    const postId = clickedId.split("-")[1];

                    console.log("Clicked ID:", clickedId,"PostID", postId, `makeChangesButton-${postId}`);

                    if(clickedId=== `makeChangesButton-${postId}`){

                        const makeChangesDivId = `makeChangesDiv-${postId}`;
                        const makeChangesDiv = document.getElementById(makeChangesDivId);

                        makeChangesDiv.style.display = "flex";


                        const imgElement = document.getElementById(`changeImage-${postId}`);

                        const changeImageDivId = `imagesChangePost-${postId}`;
                        const changeImageDiv = document.getElementById(changeImageDivId);


                        const imgSrc = imgElement.src;

                        // Set the background image of "changeImageDiv"
                        changeImageDiv.style.backgroundImage = `url(${imgSrc})`;

                    }
                    else{
                        document.querySelector(".makeReviewDiv").style.display = "flex";
                    }
                });
            });

            feedContentButton.addEventListener("click", (event) => {
                event.stopPropagation();
                if(!feedContentButton.classList.contains('active')){
                    feedContentButton.classList.toggle("active");
                    productContentButton.classList.toggle("active");
                }
                feedContentDiv.style.display = "flex";
                productContentDiv.style.display = "none";
            });

            productContentButton.addEventListener("click", (event) => {
                event.stopPropagation();
                if(!productContentButton.classList.contains('active')){
                    feedContentButton.classList.toggle("active");
                    productContentButton.classList.toggle("active");
                }
                
                feedContentDiv.style.display = "none";
                productContentDiv.style.display = "flex";
            });


            cancelButtons.forEach((icon) => {
                icon.addEventListener("click", (event) => {
                    event.stopPropagation();

                    const clickedId = event.target.id;
                    console.log("Clicked ID:", clickedId);
                    const postId = clickedId.split("-")[1];

                    const makeChangesDivId = `makeChangesDiv-${postId}`;
                    const makeChangesDiv = document.getElementById(makeChangesDivId);

                    const reviewPostId = `reviewPostContainer-${postId}`;
                    const reviewPost =  document.getElementById(reviewPostId);

                    if(clickedId===`cancelPostIcon-${postId}`){
                        makeChangesDiv.style.display = "none";
                    }
                    else if(clickedId === `deletePostIcon-${postId}`){
                        console.log("thos", reviewPostId)
                        reviewPost.classList.toggle("active");
                        
                        to_delete_list.push(postId);
                        console.log(to_delete_list);
                    }
                    else if(clickedId === `closePostIcon-${postId}`){
                        document.getElementById(`viewPostDivBackground-${postId}`).style.display = "none";
                    }
                    
                });
            });

            undoDeletePostButtons.forEach((icon) => {
                icon.addEventListener("click", (event) => {
                    event.stopPropagation();
                    const clickedId = event.target.id;
                    console.log("Clicked ID:", clickedId);
                    const postId = clickedId.split("-")[1];

                    
                    
                    to_delete_list = to_delete_list.filter(item => item !== postId);
                    console.log(to_delete_list);

                    const reviewPostId = `reviewPostContainer-${postId}`;
                    const reviewPost =  document.getElementById(reviewPostId);

                    reviewPost.classList.toggle("active");

                });
            });


            function deletePostFunction (){

                to_delete_list.map((postId, index) => {
                    console.log("thus", postId);
                    const searchForm = document.getElementById(`deletePostForm-${postId}`);
                    searchForm.submit();
                });
            }



            // Function to save the scroll position in the browser's history
            function saveScrollPosition() {
                const scrollY = window.scrollY || window.pageYOffset;
                history.pushState({ scrollY }, document.title, location.href);
            }

            // Listen for user scrolling and save the scroll position
            window.addEventListener('scroll', saveScrollPosition);

            // Restore scroll position when the page is loaded
            window.addEventListener('popstate', function(event) {
                if (event.state && event.state.scrollY) {
                    window.scrollTo(0, event.state.scrollY);
                }
            });

        </script>


        <script>

            function clicked(button){
                button.classList.toggle('active');
            }

            const likeButtons = document.querySelectorAll(".fa-solid.fa-arrow-up.fa-lg");
            likeButtons.forEach((button) => {
                button.addEventListener("click", (event) => {
                    event.stopPropagation();
                    clicked(button);

                    if(event.target.classList[2] === "fa-rotate-180"){
                        //the backend call for disliike button
                        console.log("dislike")
                    }
                    else{
                        //the backend call for like button
                        console.log("like")
                    }
                });
            });

            const heartButtons = document.querySelectorAll(".fa-solid.fa-heart.fa-lg");
            heartButtons.forEach((button) => {
                button.addEventListener("click", (event) => {
                    event.stopPropagation();
                    clicked(button);
                });
            });

        </script>
        
   
</div>
   
{% endblock %}