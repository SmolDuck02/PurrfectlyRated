{% extends "master.html" %}
{% load static %}

{% block head %}
    <link rel="stylesheet" href="{% static 'home.css' %}">
{% endblock %}


{% block content %}

<div class="homeBody">

<div class="screen">
    

    <div class="searchBarContainer">
        <div class="top">
            <img src="{% static '/img/logo.png' %}" class="profileMiniUserPicture" alt="mini user pfp"/>
            <form action="">
                <input onClick={handleScrollToCenter} type="text" id="makeReview" name="makeReview" placeholder="Got something to say?" required/>
            </form>
            <button class="pawButton"><i class="fa-solid fa-paw "></i> </button>
        </div>
    </div>

    <div class="navigateContentParent">
        
            <h2 id="feedContentButton">Reviews</h2>
            <h2 id="productContentButton">Products</h2>
        
    </div>
    <div class="allReviewPostsParent">
        {% for post in post_list %}
            <div id="reviewPostContainer-{{ post.id }}">
                <div class="after">
                    <h3>This post has been deleted!</h3>
                    <form action="/undelete_post/{{ post.id }}" method="post" >
                        {% csrf_token %}
                        <!-- <button class="noStyle"> -->
                            <i id="undoDeletePostButton-{{ post.id }}" class="fa-solid fa-arrow-rotate-left fa-lg"></i>
                        <!-- </button> -->
                    </form>
                   
                </div>
                
                <div class="before">
                    <div class="headerPost">
                        <img src="{% static '/img/logo.png' %}" class="profileMiniUserPicture" alt="mini user pfp"/>
                        <div class="userPostDetails">
                            <h2>{{ post.postUser__username | title }}</h2>
                            <span>{{ post.datetimePublished }}</span>
                        </div>
                        {% if post.postUser__id == request.session.user_id %}
                            <i id="makeChangesButton-{{ post.id }}" class="fa-solid fa-pen"></i>
                        {% endif %}
                        
                        <div style="width: 10px;"></div>
                        {% if post.postUser__username != 'admin' %}
                            <form id="deletePostForm-{{ post.id }}" action="/delete_post/{{ post.id }}" method="post">
                                {% csrf_token %}
                                <!-- <button class="noStyle"> -->
                                    <i id="deletePostIcon-{{ post.id }}" class="fa-solid fa-x fa-lg"></i>
                                <!-- </button> -->
                            </form>
                        {% endif %}

                        <!-- <i class="fa-solid fa-ellipsis fa-lg" style="color: #cc8033;"></i> -->
                    </div>
                    <div class="descriptionPost">
                        <span>{{ post.post_description }}</span>
                        <!-- <span>Lorem Ipsum Lorem Ipsum Lorem Ipsum Lorem Ipsum Lorem Ipsum </span> -->
                    </div>
                    <div class="imagesPost">
                        <img id="changeImage-{{ post.id }}" src="/media/{{ post.post_picture }}" alt="postImages">
                    </div>
                    <div class="buttonsPost">
                        <div>
                            <i class="fa-solid fa-arrow-up fa-xl"></i>
                            <i class="fa-solid fa-arrow-up fa-rotate-180 fa-xl"></i>
                        </div>
                        <i class="fa-solid fa-comment fa-xl"></i>
                        <i class="fa-solid fa-paw fa-xl"></i>
                    
                    </div>
                    
                </div>
            </div>
            


            
            <div id="makeChangesDiv-{{ post.id }}">
                <div class="makeReviewForm">
                    <div class="before">
                        <div class="headerPost">
                            <img src="{% static '/img/logo.png' %}" class="profileMiniUserPicture" alt="mini user pfp"/>
                            <div class="userPostDetails">
                                <h2>{{ user.username | title }}</h2>
                            </div>
                            <i id="cancelPostIcon-{{ post.id }}" class="fa-solid fa-x" style="cursor: pointer;"></i>
                
                            <!-- <i class="fa-solid fa-ellipsis fa-lg" style="color: #cc8033;"></i> -->
                        </div>
                        <form action="/update_post/{{ post.id }}" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="descriptionPost">
                                <textarea id="description" name="description" style="width: 100%; background-color:#ffead1; height: 20px; padding: 10px; border: none;" placeholder="Speak Now...">{{ post.post_description }}</textarea>
                                <!-- <input id="postDescription" name="postDescription" type="text"  style="white-space: pre-wrap;" placeholder="Speak Now..." required> -->
                            </div>
                            
                            <div id="imagesChangePost-{{ post.id }}" class="imagesChangePostDiv">
                                <i class="fa-solid fa-image fa-lg">&nbsp; Add Images</i>
                                <input type="file" id="changeImageInput-{{ post.id }}" name="changeImageInput" accept="image/*" style="display: none;" />
                            </div>
                            <button type="submit" id="publishReviewButton">Save Changes</button>
                        </form>
                        
                    </div>
                </div>
            </div>


        
            
        {% endfor %}
    </div>

    <div class="allProductPostsParent">
        {% for product in product_list %}
            <div class="productContainer">
                <img src="/media/{{ product.product_picture }}">
                <div class="productCategoryContainer">
                    <i class="{{ product.product_category__category_icon }}"></i>
                    <h5>{{ product.product_category__category_name }}</h5>
                </div>
                <div class="productNameContainer">
                    <h3>{{ product.product_name }}</h3>
                    <i id="makeReviewButton" class="fa-solid fa-pen"></i>
                </div>
                
            </div>
        {% endfor %}
    </div>

    <div class="makeReviewDiv">
        <div class="makeReviewForm">
            <div class="before">
                <div class="headerPost">
                    <img src="{% static '/img/logo.png' %}" class="profileMiniUserPicture" alt="mini user pfp"/>
                    <div class="userPostDetails">
                        <h2>{{ user.username | title }}</h2>
                    </div>
                    <i id="cancelPostIcon" class="fa-solid fa-x" style="cursor: pointer;"></i>
        
                    <!-- <i class="fa-solid fa-ellipsis fa-lg" style="color: #cc8033;"></i> -->
                </div>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="descriptionPost">
                        <textarea id="description" name="description" style="width: 100%; background-color:#ffead1; height: 20px; padding: 10px; border: none;" placeholder="Speak Now..."></textarea>
                        <!-- <input id="postDescription" name="postDescription" type="text"  style="white-space: pre-wrap;" placeholder="Speak Now..." required> -->
                    </div>
                    
                    <div class="imagesAddPost">
                        <i class="fa-solid fa-image fa-lg" >&nbsp; Add Images</i>
                        <input type="file" id="uploadImageInput" name="uploadImageInput" accept="image/*" style="display: none;" />
                    </div>
                    <button type="submit" id="publishReviewButton">Publish Review</button>
                </form>
                
            </div>
        </div>
    </div>

    <script>

        let to_delete_list = [];
        const feedContentButton = document.getElementById("feedContentButton");
        const productContentButton = document.getElementById("productContentButton");
        const deletePostIcon = document.getElementById("deletePostIcon");
        
        const undoDeletePostButtons = document.querySelectorAll(".fa-solid.fa-arrow-rotate-left.fa-lg");

        const makeChangesButton = document.getElementById("makeChangesButton");
        const makeReviewButtons = document.querySelectorAll(".fa-solid.fa-pen");
        const cancelButtons = document.querySelectorAll(".fa-solid.fa-x");
        // const cancelPostIcon = document.getElementById("cancelPostIcon");
        
        const uploadImageDiv = document.querySelector(".imagesAddPost");
        const uploadImageInput = document.getElementById("uploadImageInput");

        // const post = document.querySelector(".reviewPostContainer");
        
        // const makeChangesDiv = document.querySelector(".makeChangesDiv");
        const makeReviewDiv =document.querySelector(".makeReviewDiv");
        const feedContentDiv = document.querySelector(".allReviewPostsParent");
        const reviewContentDiv = document.querySelector(".allProductPostsParent");


        const makeReview = document.getElementById("makeReview");

        makeReview.addEventListener("click", (event) => {
            event.stopPropagation();
            makeReviewDiv.style.display = "flex";
        });


        
        
        const imagesChangePostDivs = document.querySelectorAll(".imagesChangePostDiv");
        // const changeImageInput = document.getElementById("changeImageInput");
        


        imagesChangePostDivs.forEach((div) => {

            const changeImageInput = div.querySelector('input[type="file"]');

            div.addEventListener("click", (event) => {
                event.stopPropagation();
                changeImageInput.click();
            });

            changeImageInput.addEventListener('change', function () {
                const selectedFile = this.files[0];
                if (selectedFile) {
                    const imageURL = URL.createObjectURL(selectedFile);
                    div.style.backgroundImage = `url(${imageURL})`;
                }
            });
        });

        

        function deletePost (postId){
            const searchForm = document.getElementById(`deletePostForm-${postId}`);
            
            setInterval(() => {
                if(searchForm){
                searchForm.submit();
                }
            }, 4000);
            
        }

        
        




        uploadImageDiv.addEventListener('click', () => {
            // Trigger the hidden file input when the div is clicked
            uploadImageInput.click();
        });

        uploadImageInput.addEventListener('change', function () {
            // Handle the selected image here
            const selectedFile = this.files[0];
            if (selectedFile) {
                // You can perform actions with the selected image, e.g., display it, upload it, etc.
                const imageURL = URL.createObjectURL(selectedFile);

                // Set the background image of the div using the imageURL
        
                uploadImageDiv.style.backgroundImage = `url(${imageURL})`;
            }
        });


        makeReviewButtons.forEach((icon) => {
            icon.addEventListener("click", (event) => {
                event.stopPropagation();

                const clickedId = event.target.id;
                const postId = clickedId.split("-")[1];

                console.log("Clicked ID:", clickedId,"PostID", postId, `makeChangesButton-${postId}`);

                if(clickedId=== `makeChangesButton-${postId}`){

                    const makeChangesDivId = `makeChangesDiv-${postId}`;
                    const makeChangesDiv = document.getElementById(makeChangesDivId);

                    makeChangesDiv.style.display = "flex";


                    const imgElement = document.getElementById(`changeImage-${postId}`);

                    const changeImageDivId = `imagesChangePost-${postId}`;
                    const changeImageDiv = document.getElementById(changeImageDivId);


                    const imgSrc = imgElement.src;

                    // Set the background image of "changeImageDiv"
                    changeImageDiv.style.backgroundImage = `url(${imgSrc})`;


                }
                else{
                    makeReviewDiv.style.display = "flex";
                }
            });
        });

        cancelButtons.forEach((icon) => {
            icon.addEventListener("click", (event) => {
                event.stopPropagation();


                const clickedId = event.target.id;
                console.log("Clicked ID:", clickedId);

                const postId = clickedId.split("-")[1];

                const makeChangesDivId = `makeChangesDiv-${postId}`;
                const makeChangesDiv = document.getElementById(makeChangesDivId);

                const reviewPostId = `reviewPostContainer-${postId}`;
                const reviewPost =  document.getElementById(reviewPostId);

                if(clickedId===`cancelPostIcon-${postId}`){
                    makeChangesDiv.style.display = "none";
                }
                else if(clickedId === 'cancelPostIcon'){
                    makeReviewDiv.style.display = "none";
                    uploadImageDiv.style.backgroundImage = "none";
                }
                else if(clickedId === `deletePostIcon-${postId}`){
                    console.log("thos", reviewPostId)
                    reviewPost.classList.toggle("active");
                    
                    to_delete_list.push(postId);
                    console.log(to_delete_list);

                    deletePost(postId);
                }
                
            });
        });


        // cancelPostIcon.addEventListener("click", (event) => {
        //     event.stopPropagation();
        //     makeReviewDiv.style.display = "none";
        //     uploadImageDiv.style.backgroundImage = "none";
        // });


        feedContentButton.addEventListener("click", (event) => {
            event.stopPropagation();

            // Change the display property to "none" to hide the element
            feedContentDiv.style.display = "flex";
            reviewContentDiv.style.display = "none";
        });

        productContentButton.addEventListener("click", (event) => {
            event.stopPropagation();

            feedContentDiv.style.display = "none";
            reviewContentDiv.style.display = "flex";
        });

        undoDeletePostButtons.forEach((icon) => {
            icon.addEventListener("click", (event) => {
                event.stopPropagation();


                const clickedId = event.target.id;
                console.log("Clicked ID:", clickedId);
                const postId = clickedId.split("-")[1];

                let newArray = to_delete_list.filter(item => item !== postId);
                to_delete_list = newArray;
                console.log(to_delete_list);

                const reviewPostId = `reviewPostContainer-${postId}`;
                const reviewPost =  document.getElementById(reviewPostId);

                reviewPost.classList.toggle("active");
                
            });
        });

        // deletePostIcon.addEventListener("click", () => {
        //     post.classList.toggle("active");
        // });

        // undoDeletePostButton.addEventListener("click", () => {
        //     post.classList.toggle("active");
        // });



    </script>
    
</div>
</div>
   
{% endblock %}



<!-- <!DOCTYPE html>
<html>
    <link rel="stylesheet" href="{% static 'post.css' %}">
    <body>
        <h1>Yamamama</h1>
    </body>
</html> -->